<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>WordPress Calculator</title>
  </head>
  <body>
    <div class="calculator-container">
      <h1 class="container">Calculate your statistical significance</h1>
      <div class="calculator-wrapper">
        <form
          name="calculatorForm"
          id="calculatorForm"
          class="calculator"
          action=""
        >
          <div class="calculator-grid">
            <div class="calculator-grid-item"></div>
            <div class="calculator-grid-item">
              <p class="calculator-label calculator-ylabel">Visitors</p>
            </div>
            <div class="calculator-grid-item">
              <p class="calculator-label calculator-ylabel">Conversions</p>
            </div>
            <div class="calculator-grid-item"></div>
            <div class="calculator-grid-item calculator-pr20">
              <p class="calculator-label calculator-ylabel">Conversion Rate</p>
            </div>
            <div class="calculator-grid-item calculator-white-background">
              <p class="calculator-label">A</p>
            </div>
            <div
              class="calculator-grid-item calculator-white-background calculator-input-container"
            >
              <input
                type="number"
                name="visitorsA"
                id="visitorsA"
                value="50000"
              />
            </div>
            <div
              class="calculator-grid-item calculator-white-background calculator-input-container"
            >
              <input
                type="number"
                name="conversionsA"
                id="conversionsA"
                value="500"
              />
            </div>
            <div
              class="calculator-grid-item calculator-white-background calculator-pr10"
            >
              <svg
                preserveAspectRatio="xMidYMid meet"
                viewBox="0 0 16 16"
                aria-label="ArrowRight"
                title="ArrowRight"
              >
                <g>
                  <path
                    d="m15.9177 7.7134a.75.75 0 0 0 -.1618-.2436l-6.04-6.04a.75.75 0 1 0 -1.0601 1.0602l4.7593 4.76h-12.6397a.75.75 0 1 0 0 1.5h12.64l-4.7596 4.76a.75.75 0 1 0 1.0605 1.06l6.04-6.04a.7527.7527 0 0 0 .1618-.8169z"
                  ></path>
                </g>
              </svg>
            </div>
            <div
              class="calculator-grid-item calculator-white-background calculator-pr20"
            >
              <p id="rateA" class="calculator-rate-result">1.00%</p>
            </div>
            <div class="calculator-grid-item calculator-rowB">
              <p class="calculator-label">B</p>
            </div>
            <div
              class="calculator-grid-item calculator-rowB calculator-input-container"
            >
              <input
                class="calculator-lighten"
                type="number"
                name="visitorsB"
                id="visitorsB"
                value="50000"
              />
            </div>
            <div
              class="calculator-grid-item calculator-rowB calculator-input-container"
            >
              <input
                class="calculator-lighten"
                type="number"
                name="conversionsB"
                id="conversionsB"
                value="570"
              />
            </div>
            <div class="calculator-grid-item calculator-rowB calculator-pr10">
              <svg
                preserveAspectRatio="xMidYMid meet"
                viewBox="0 0 16 16"
                aria-label="ArrowRight"
                title="ArrowRight"
              >
                <g>
                  <path
                    d="m15.9177 7.7134a.75.75 0 0 0 -.1618-.2436l-6.04-6.04a.75.75 0 1 0 -1.0601 1.0602l4.7593 4.76h-12.6397a.75.75 0 1 0 0 1.5h12.64l-4.7596 4.76a.75.75 0 1 0 1.0605 1.06l6.04-6.04a.7527.7527 0 0 0 .1618-.8169z"
                  ></path>
                </g>
              </svg>
            </div>
            <div class="calculator-grid-item calculator-rowB calculator-pr20">
              <p id="rateB" class="calculator-rate-result">1.14%</p>
            </div>
          </div>
          <div class="controls-container">
            <div class="controls">
              <p>Hypothesis</p>
              <div class="controls-radius">
                <label for="oneSided"
                  >One-sided
                  <input
                    type="radio"
                    name="hypothesis"
                    id="oneSided"
                    value="onesided"
                    checked
                  />
                  <span class="custom-radio"></span>
                </label>
                <label for="twoSided"
                  >Two-sided
                  <input
                    type="radio"
                    name="hypothesis"
                    id="twoSided"
                    value="twosided"
                  />
                  <span class="custom-radio"></span>
                </label>
              </div>
            </div>
            <div class="controls">
              <p>Confidence</p>
              <div class="controls-radius">
                <label for="90Percent"
                  >90%
                  <input
                    type="radio"
                    name="confidence"
                    id="90Percent"
                    value="90"
                    checked
                  />
                  <span class="custom-radio"></span>
                </label>
                <label for="95Percent"
                  >95%
                  <input
                    type="radio"
                    name="confidence"
                    id="95Percent"
                    value="95"
                  />
                  <span class="custom-radio"></span>
                </label>
                <label for="99Percent"
                  >99%
                  <input
                    type="radio"
                    name="confidence"
                    id="99Percent"
                    value="99"
                  />
                  <span class="custom-radio"></span>
                </label>
              </div>
            </div>
          </div>
          <button type="submit" class="calculator-button">Calculate</button>
        </form>
        <div class="results-container">
          <div class="results">
            <h3 id="resultTitle" class="results-title">Significant result!</h3>
            <p id="resultText">
              Variant B’s conversion rate (1.14)% was higher than variant A’s
              conversion rate (1.00)%. You can be 90% confident that variant B
              will perform better than variant A.
            </p>
            <div class="results-values">
              <div>
                <p>p value</p>
                <p id="pValue">0.0157</p>
              </div>
            </div>
          </div>
          <div id="resultsAlert" class="results-alert">
            <h3 class="results-alert-title">SRM alert</h3>
            <p class="results-alert-body">
              Assuming you intented to have a 50% / 50% split, a Sample Ratio
              Mismatch (SRM) check indicates there might be a problem with your
              distribution.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const normalcdf = (mean, sigma, x) => {
        var z = (x - mean) / Math.sqrt(2 * sigma * sigma);
        var t = 1 / (1 + 0.3275911 * Math.abs(z));
        var a1 = 0.254829592;
        var a2 = -0.284496736;
        var a3 = 1.421413741;
        var a4 = -1.453152027;
        var a5 = 1.061405429;
        var erf =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
        var sign = 1;
        if (z < 0) {
          sign = -1;
        }
        return (1 / 2) * (1 + sign * erf);
      };

      const form = document.getElementById("calculatorForm");
      const alert = document.getElementById("resultsAlert");
      const resultTitle = document.getElementById("resultTitle");
      const resultBody = document.getElementById("resultText");
      const calculatorContainer = document.querySelector(
        ".calculator-container"
      );

      const significant = (pcrB, pcrA, conf, pVal) => {
        let finalText;
        let significantHigherText = `
        Variant B’s conversion rate (${parseFloat(pcrB).toFixed(
          2
        )})% was higher than variant A’s conversion rate (${parseFloat(
          pcrA
        ).toFixed(
          2
        )})%. You can be ${conf}% confident that variant B will perform better than variant A.
        `;
        let significantLowerText = `
        Variant B’s conversion rate (${parseFloat(pcrB).toFixed(
          2
        )})% was lower than variant A’s conversion rate (${parseFloat(
          pcrA
        ).toFixed(
          2
        )})%. You can be ${conf}% confident that variant B will perform worse than variant A.
        `;

        let notSignificantEqualText = `
        Variant B’s conversion rate (${parseFloat(pcrB).toFixed(
          2
        )})% was equal to variant A’s conversion rate (${parseFloat(
          pcrA
        ).toFixed(
          2
        )})%. You cannot say, with ${conf}% confidence, that variant B will perform better or worse than variant A.
        `;
        let notSignificantHigherText = `
        Variant B’s conversion rate (${parseFloat(pcrB).toFixed(
          2
        )})% was higher than variant A’s conversion rate (${parseFloat(
          pcrA
        ).toFixed(
          2
        )})%, but you cannot say, with ${conf}% confidence, that variant B will perform better than variant A.
        `;
        let notSignificantLowerText = `
        Variant B’s conversion rate (${parseFloat(pcrB).toFixed(
          2
        )})% was lower than variant A’s conversion rate (${parseFloat(
          pcrA
        ).toFixed(
          2
        )})%, but you cannot say, with ${conf}% confidence, that variant B will perform worse than variant A.
        `;

        if (
          (conf == 90 && (pVal < 0.1 || pVal > 0.9)) ||
          (conf == 95 && (pVal < 0.05 || pVal > 0.95)) ||
          (conf == 99 && (pVal < 0.01 || pVal > 0.99))
        ) {
          if (pcrB > pcrA) {
            finalText = significantHigherText;
          } else {
            finalText = significantLowerText;
          }
          resultTitle.innerHTML = "Significant result!";
          resultBody.innerHTML = finalText;

          calculatorContainer.style.setProperty("--bRowBackground", "#afffaf");
        } else {
          if (pcrB == pcrA) {
            finalText = notSignificantEqualText;
          } else if (pcrB > pcrA) {
            finalText = notSignificantHigherText;
          } else {
            finalText = notSignificantLowerText;
          }
          resultTitle.innerHTML = "Result not significant!";
          resultBody.innerHTML = finalText;

          calculatorContainer.style.setProperty("--bRowBackground", "#ffc7af");
        }
      };

      const conversionRate = (c, v) => {
        return c / v;
      };

      const stdError = (cr, v) => {
        return Math.sqrt((cr * (1 - cr)) / v);
      };

      const zScore = (crA, crB, seA, seB) => {
        return (crA - crB) / Math.sqrt(seA ** 2 + seB ** 2);
      };

      const pValue = z => {
        return normalcdf(0, 1, z);
      };

      const proccessing = (vA, cA, vB, cB, hyp, conf) => {
        let convRateA = conversionRate(cA, vA);
        let convRateB = conversionRate(cB, vB);

        let stdErrorA = stdError(convRateA, vA);
        let stdErrorB = stdError(convRateB, vB);

        let zVal = zScore(convRateA, convRateB, stdErrorA, stdErrorB);

        let pVal = pValue(zVal);

        let pValText = document.getElementById("pValue");
        let rateAText = document.getElementById("rateA");
        let rateBText = document.getElementById("rateB");

        let printedPVal = Math.round((pVal + Number.EPSILON) * 10000) / 10000;
        let printedRateA =
          Math.round((convRateA * 100 + Number.EPSILON) * 100) / 100;
        let printedRateB =
          Math.round((convRateB * 100 + Number.EPSILON) * 100) / 100;

        pValText.innerHTML = parseFloat(printedPVal).toFixed(4);
        rateAText.innerHTML = `${parseFloat(printedRateA).toFixed(2)}%`;
        rateBText.innerHTML = `${parseFloat(printedRateB).toFixed(2)}%`;

        significant(printedRateB, printedRateA, conf, pVal);
      };

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        let visitorsA = document.getElementById("visitorsA").value;
        let conversionsA = document.getElementById("conversionsA").value;

        let visitorsB = document.getElementById("visitorsB").value;
        let conversionsB = document.getElementById("conversionsB").value;

        let confidenceInputs = document.getElementsByName("confidence");
        let confidence;

        let hypothesisInputs = document.getElementsByName("hypothesis");
        let hypothesis;

        for (let i = 0; i < confidenceInputs.length; i++) {
          if (confidenceInputs[i].checked) {
            confidence = confidenceInputs[i].value;
          }
        }

        for (let i = 0; i < hypothesisInputs.length; i++) {
          if (hypothesisInputs[i].checked) {
            hypothesis = hypothesisInputs[i].value;
          }
        }

        proccessing(
          visitorsA,
          conversionsA,
          visitorsB,
          conversionsB,
          hypothesis,
          confidence
        );

        if (
          visitorsB > visitorsA + visitorsA * 0.05 ||
          visitorsB < visitorsA - visitorsA * 0.05
        ) {
          alert.style.display = "block";
        } else {
          alert.style.display = "none";
        }
      });
    </script>
  </body>
</html>
